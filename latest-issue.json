[{"body":"\nThis document addresses a common issue developers encounter when using Next.js Middleware: unintended infinite redirect loops.  This typically occurs when middleware redirects to a route that itself triggers the same middleware, creating a recursive redirect chain that never terminates.\n\n## Description of the Error\n\nThe error doesn't manifest as a specific error message in the console. Instead, you'll observe your browser continuously loading, showing the spinning loading indicator, or experiencing an extremely slow page load.  Your browser's network tab will likely show a series of increasingly long redirect requests, indicating the infinite loop.  This often happens when you're trying to implement authentication or conditional redirects based on routes.\n\n## Code Example & Step-by-Step Fix\n\nLet's assume we're building an application where only authenticated users can access the `/dashboard` route.  An incorrect implementation might lead to an infinite redirect:\n\n**Incorrect Middleware (`middleware.js`):**\n\n```javascript\nimport { NextResponse } from 'next/server';\n\nexport function middleware(req) {\n  const session = req.cookies.get('session'); // Simplistic session check\n\n  if (!session) {\n    return NextResponse.redirect(new URL('/login', req.url));\n  }\n}\n\nexport const config = {\n  matcher: ['/dashboard'],\n};\n```\n\n**Incorrect Login Page (`pages/login.js`):**  This would cause the infinite loop because the `/login` page also triggers the `middleware` if it doesn't have a session cookie.\n\n```javascript\n// pages/login.js - some basic login page\nexport default function Login() {\n    return <div>Login Page</div>;\n}\n```\n\n**Step 1: Identifying the Loop**\n\nCarefully examine your middleware's logic and the routes it redirects to. Look for cases where the redirect target also triggers the same middleware.  In this example, both `/dashboard` and `/login` indirectly or directly trigger the same middleware leading to a loop.\n\n**Step 2:  Using `next/server.js` to prevent redirection of /login**\n\nThe correct solution requires that the `/login` path *doesn't* trigger the middleware again.  We can achieve this by using the `matcher` config more precisely.\n\n**Corrected Middleware (`middleware.js`):**\n\n```javascript\nimport { NextResponse } from 'next/server';\n\nexport function middleware(req) {\n  const session = req.cookies.get('session');\n\n  if (!session) {\n    return NextResponse.redirect(new URL('/login', req.url));\n  }\n}\n\nexport const config = {\n  matcher: ['/dashboard/:path*'], // Only match routes starting with /dashboard\n};\n```\n\n**Step 3:  Consider a different approach for protected routes (if possible)**\n\nIn many cases, the best solution would be to check authentication on the protected component itself using `getServerSideProps` or `getStaticProps` to fetch user data, or using a library like `next-auth` to manage authentication.\n\n**Corrected Dashboard Page (`pages/dashboard.js`):**\n\n```javascript\nimport { getSession } from 'next-auth/react';\n\nexport async function getServerSideProps(context) {\n  const session = await getSession(context);\n  if (!session) {\n    return {\n      redirect: {\n        destination: '/login',\n        permanent: false,\n      },\n    };\n  }\n  return { props: { session } };\n}\n\nexport default function Dashboard({ session }) {\n  return (\n    <div>\n      <h1>Dashboard</h1>\n      <p>Welcome, {session.user.email}!</p>\n    </div>\n  );\n}\n```\n\nThis approach moves authentication logic to the component itself, preventing the middleware from recursively redirecting.\n\n\n\n## Explanation\n\nThe infinite redirect occurs because the middleware's redirect logic is recursively called. By carefully defining the `matcher` property in the middleware's `config` object,  we explicitly control which routes trigger the middleware.  Furthermore, moving the authentication check to the protected route, ensures that the middleware is only used for a single redirection.\n\n\n## External References\n\n* [Next.js Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)\n* [NextAuth.js](https://next-auth.js.org/) - A popular authentication library for Next.js.\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":1110,"title":"Next.js Middleware: Preventing Infinite Redirects"}]
