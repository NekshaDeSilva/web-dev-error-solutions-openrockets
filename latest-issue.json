[{"body":"\nThis document addresses a common error encountered when working with Next.js Middleware: attempting to import modules from `next/server` within files that are *not* middleware functions.  This often leads to runtime errors or unexpected behavior.\n\n**Description of the Error:**\n\nWhen you try to import modules like `NextResponse` from `next/server` in a file that's not a middleware function (e.g., a regular component, API route, or a utility function), you'll likely receive an error similar to:\n\n```\nError: Cannot find module 'next/server'\n```\n\nor a more cryptic error related to the specific module you're trying to import (like `NextResponse`). This happens because `next/server` modules are specifically designed for the server-side execution environment of middleware and API routes. They aren't available in the client-side rendering context of components or in other general server-side code.\n\n\n**Step-by-Step Code Fix:**\n\nLet's assume you have a utility function `redirectUser.js` that attempts to use `NextResponse` incorrectly:\n\n**Incorrect `redirectUser.js`:**\n\n```javascript\n// incorrect-redirectUser.js\nimport { NextResponse } from 'next/server';\n\nexport function redirectUser(req, res, redirectUrl) {\n  return NextResponse.redirect(new URL(redirectUrl, req.url));\n}\n```\n\nThis will fail because `redirectUser.js` isn't a middleware function. To fix this, you need to refactor your code to use appropriate modules depending on the context.\n\n**Correct Implementation (Middleware):**\n\nIf `redirectUser` logic should be within middleware, create a middleware file (e.g., `middleware.js` in `pages`):\n\n```javascript\n// pages/middleware.js\nimport { NextResponse } from 'next/server';\n\nexport function middleware(req) {\n  const redirectUrl = '/some-page'; // Logic to determine redirect URL\n  if (condition) {\n    return NextResponse.redirect(new URL(redirectUrl, req.url));\n  }\n}\n\nexport const config = {\n  matcher: ['/some-route'], // Match only specific routes\n}\n```\n\n**Correct Implementation (API Route):**\n\nIf the redirection logic should happen in an API route, use the standard API route approach:\n\n```javascript\n// pages/api/redirect.js\nexport default function handler(req, res) {\n  const redirectUrl = '/some-page'; // Logic to determine redirect URL\n  res.redirect(307, redirectUrl); // Perform redirect\n}\n```\n\n**Correct Implementation (within a component with a server-side function):**\n\nIf the redirection is needed inside a component you can use a server-side function like `getServerSideProps` or `getStaticProps` within your component but use `res` to do the redirection.\n\n\n```javascript\n// pages/my-page.js\nimport { useRouter } from 'next/router';\n\nexport async function getServerSideProps({ res }) {\n    const redirectUrl = '/another-page';\n\n    // Perform server-side logic, then redirect if necessary\n\n    if (condition) {\n        return {\n            redirect: {\n                destination: redirectUrl,\n                permanent: false,\n            },\n        };\n    }\n\n    return { props: {} };\n}\n\nexport default function MyPage() {\n  return (\n    <div>\n      {/* ...Your component JSX... */}\n    </div>\n  );\n}\n```\n\n\n\n**Explanation:**\n\nThe core issue stems from the different contexts in Next.js.  `next/server` modules are strictly server-side and are not compatible with the client-side rendering environment or other general server contexts.  By carefully placing the logic requiring `next/server` imports within the appropriate middleware functions or API routes, you avoid this error. Using the correct methods for redirection within those respective environments ensures that your code functions correctly and avoids compatibility issues.\n\n**External References:**\n\n* [Next.js Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)\n* [Next.js API Routes Documentation](https://nextjs.org/docs/api-routes/introduction)\n* [Next.js Server-Side Rendering Documentation](https://nextjs.org/docs/basic-features/pages#server-side-rendering)\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":1067,"title":"Next.js Middleware: Handling `next/server` Imports Outside of Middleware"}]
