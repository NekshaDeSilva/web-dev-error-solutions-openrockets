[{"body":"\n## Description of the Error\n\nA common issue arises when attempting to use data fetched within `getServerSideProps` (or `getStaticProps` with `revalidate`) within a component that also utilizes `getStaticProps`.  The problem stems from the fact that `getStaticProps` runs at build time (or during revalidation) and doesn't have access to the request-specific data retrieved by `getServerSideProps` (which runs on every request).  Trying to access such data directly will result in undefined values or runtime errors when pre-rendering the page.\n\n\n## Code Example: The Problem\n\nLet's imagine a scenario where we fetch user data based on a session ID, which we want to display on a user profile page.\n\n**pages/profile.js:**\n\n```javascript\nimport { getServerSideProps } from 'next/server';\nimport { getSession } from 'next-auth/react';\n\nexport async function getServerSideProps(context) {\n  const session = await getSession(context);\n\n  if (!session) {\n    return {\n      redirect: {\n        destination: '/login',\n        permanent: false,\n      },\n    };\n  }\n\n  const res = await fetch(`https://api.example.com/user/${session.user.id}`);\n  const userData = await res.json();\n\n  return {\n    props: { userData },\n  };\n}\n\nexport default function Profile({ userData }) {\n  return (\n    <div>\n      <h1>Profile</h1>\n      <p>Name: {userData.name}</p>  {/* This might be undefined at build time */}\n      <p>Email: {userData.email}</p> {/* This might be undefined at build time */}\n    </div>\n  );\n}\n```\n\nThis code works perfectly for server-side rendering, but will throw errors if used for static site generation (SSG) because `userData` will be undefined during the build process.\n\n\n## Fixing the Issue Step-by-Step\n\nTo resolve this, we need to separate the data fetching into a function accessible by both `getServerSideProps` and the component.\n\n**pages/profile.js (Fixed):**\n\n```javascript\nimport { getServerSideProps } from 'next/server';\nimport { getSession } from 'next-auth/react';\n\nasync function fetchUserData(session) {\n  if (!session) {\n    return null;\n  }\n  const res = await fetch(`https://api.example.com/user/${session.user.id}`);\n  return res.json();\n}\n\n\nexport async function getServerSideProps(context) {\n  const session = await getSession(context);\n  const userData = await fetchUserData(session);\n\n  if (!userData) {\n      return {\n        redirect: {\n          destination: '/login',\n          permanent: false,\n        },\n      };\n  }\n\n  return {\n    props: { userData },\n  };\n}\n\nexport default function Profile({ userData }) {\n  // Fallback to prevent errors during build time\n  if (!userData) return <div>Loading...</div>;\n\n  return (\n    <div>\n      <h1>Profile</h1>\n      <p>Name: {userData.name}</p>\n      <p>Email: {userData.email}</p>\n    </div>\n  );\n}\n```\n\n**Explanation:**\n\n1. **`fetchUserData` function:** This function encapsulates the API call, making it reusable.\n2. **`getServerSideProps`:**  This function calls `fetchUserData` after getting the session.  It handles redirection if no session exists.\n3. **Conditional Rendering:** The component now includes a fallback (`<div>Loading...</div>`) to handle the case where `userData` is initially undefined during build time or revalidation.  Once the data is fetched on the server, the actual profile data will be displayed.\n\nThis approach ensures that the data is fetched correctly during server-side rendering, while also preventing errors during the build process.\n\n\n\n## External References\n\n* [Next.js Official Documentation on `getServerSideProps`](https://nextjs.org/docs/basic-features/data-fetching/getserversideprops)\n* [Next.js Official Documentation on `getStaticProps`](https://nextjs.org/docs/basic-features/data-fetching/getstaticprops)\n* [NextAuth.js Documentation](https://next-auth.js.org/) (for authentication example)\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":1248,"title":"Next.js Middleware: Handling `getServerSideProps` Data in `getStaticProps`"}]
