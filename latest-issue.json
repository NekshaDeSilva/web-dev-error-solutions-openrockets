[{"body":"\nThis document addresses a common error encountered when using Next.js Middleware: `TypeError: next.json.rewrite is not a function`. This error typically arises when attempting to use the `rewrite` method within middleware incorrectly, often due to misunderstanding its usage within the context of the `next` object.  The `rewrite` method is specifically designed for manipulating the incoming request's path and is not available in all middleware contexts or configurations.\n\n**Description of the Error:**\n\nThe error message `TypeError: next.json.rewrite is not a function` indicates that you're trying to call the `rewrite` method on a `next` object that doesn't have this functionality. This commonly occurs when:\n\n1. **Incorrect Middleware placement:** The middleware is defined in an incorrect location or isn't properly configured within the `middleware.ts` or `middleware.js` file.\n2. **Incorrect `next` object usage:** The `next` object you're using within the middleware doesn't offer the `rewrite` functionality.\n3. **Incompatible Next.js Version:**  Older versions of Next.js may not support the `rewrite` method in middleware as expected.\n\n**Code and Step-by-Step Fix:**\n\nLet's assume we want to rewrite requests to `/old-path` to `/new-path`.  The incorrect implementation might look like this:\n\n\n```javascript\n// middleware.js (INCORRECT)\nexport function middleware(req, res) {\n  if (req.nextUrl.pathname === '/old-path') {\n    next.json.rewrite('/new-path'); // Incorrect usage!\n  }\n}\nexport const config = {\n  matcher: ['/old-path'],\n}\n```\n\nThis will result in the error. The correct implementation utilizes the `next.rewrite` function within the `nextResponse` object:\n\n```javascript\n// middleware.js (CORRECT)\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  if (req.nextUrl.pathname === '/old-path') {\n    const res = NextResponse.rewrite(new URL('/new-path', req.url));\n    return res;\n  }\n}\n\nexport const config = {\n  matcher: ['/old-path'],\n};\n```\n\n**Explanation:**\n\nThe corrected code uses `NextResponse.rewrite()`. This correctly redirects the request to the new path.  The key difference is using `NextResponse` to create a response object and then using the `rewrite` method on that response object, rather than directly on the `next` object.  The `new URL('/new-path', req.url)` constructs a new URL object, ensuring the rewrite maintains any query parameters or other URL components from the original request.\n\n**External References:**\n\n* **Next.js Middleware documentation:** [https://nextjs.org/docs/app/building-your-application/routing/middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)  (Check for the latest version as documentation changes)\n* **NextResponse API:**  [https://nextjs.org/docs/app/api-reference/functions/next-response](https://nextjs.org/docs/app/api-reference/functions/next-response) (Check for the latest version as documentation changes)\n\n\n**Important Considerations:**\n\n* **Matcher:** The `matcher` property in `config` is crucial. It defines which routes the middleware applies to.  Incorrectly configured matchers can lead to unexpected behavior or the error described above.\n* **Next.js Version:** Ensure you're using a version of Next.js that fully supports the `NextResponse` object and its methods. Check the Next.js release notes for any changes related to middleware.\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":776,"title":"Dealing with `TypeError: next.json.rewrite is not a function` in Next.js Middleware"}]
