[{"body":"\nThis document addresses a common error encountered when working with Next.js Middleware:  `TypeError: Cannot read properties of undefined (reading 'map')`. This typically arises when attempting to iterate over an array or object that is unexpectedly undefined within the middleware function.  Middleware runs early in the request lifecycle, before data fetching, making it prone to this error if you're relying on data fetched from a database or API.\n\n\n**Scenario:**\n\nLet's imagine a middleware function designed to redirect users based on their role fetched from a session.  If the session data is not yet available, or the role property is missing, the `map` method will throw the error.\n\n\n**Erroneous Code:**\n\n```javascript\n// pages/api/middleware.js\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  const session = req.cookies.get('session'); //Potentially undefined!\n  const roles = session?.user?.roles || []; // Attempt to handle undefined, but might still fail\n\n  const adminRoles = roles.map(role => role.toLowerCase()); // Error occurs here if roles is undefined\n\n  if (adminRoles.includes('admin')) {\n    return NextResponse.rewrite(new URL('/admin', req.url));\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: ['/'],\n};\n```\n\n\n**Corrected Code (Step-by-Step):**\n\n\n1. **Robust Null and Undefined Checks:**  The most crucial step is to thoroughly check for `undefined` or `null` values at each stage.\n\n\n```javascript\n// pages/api/middleware.js\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  const session = req.cookies.get('session');\n\n  // Check if session exists before accessing nested properties\n  if (!session || !session.user || !session.user.roles) {\n    return NextResponse.next(); // Continue to the next middleware or page\n  }\n\n  const roles = session.user.roles;\n  const adminRoles = roles.map(role => role.toLowerCase());\n\n  if (adminRoles.includes('admin')) {\n    return NextResponse.rewrite(new URL('/admin', req.url));\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: ['/'],\n};\n```\n\n2. **Optional Chaining (?.) and Nullish Coalescing (??):**  For cleaner code, utilize optional chaining and nullish coalescing. This simplifies the null checks:\n\n```javascript\n// pages/api/middleware.js\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  const roles = req.cookies.get('session')?.user?.roles ?? []; // Use optional chaining and nullish coalescing\n\n  const adminRoles = roles.map(role => role.toLowerCase());\n\n  if (adminRoles.includes('admin')) {\n    return NextResponse.rewrite(new URL('/admin', req.url));\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: ['/'],\n};\n```\n\n\n**Explanation:**\n\nThe original code failed because it assumed the `roles` array would always exist.  The corrected code adds checks to ensure `session`, `session.user`, and `session.user.roles` are defined *before* attempting to access them.  Optional chaining and nullish coalescing make this process more concise and readable.  If any part of the chain is `null` or `undefined`, the expression short-circuits, preventing the error. The `?? []` ensures that `roles` is always an array, even if the preceding expression is nullish.\n\n\n**External References:**\n\n* [Next.js Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)\n* [Next.js API Routes Documentation](https://nextjs.org/docs/api-routes/introduction)\n* [JavaScript Optional Chaining](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining)\n* [JavaScript Nullish Coalescing](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Nullish_coalescing_operator)\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":1094,"title":"Handling `TypeError: Cannot read properties of undefined (reading 'map')` in Next.js Middleware"}]
