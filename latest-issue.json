[{"body":"\n## Description of the Error\n\nA common issue when integrating Next.js Middleware with `getServerSideProps` (or `getStaticProps`) is attempting to access data fetched in `getServerSideProps` within the middleware.  Middleware runs *before* the page component, meaning the data fetched in `getServerSideProps` is not yet available.  This leads to errors like `undefined is not an object (evaluating 'props.data.someProperty')` or similar, depending on how you're trying to access the data.\n\n\n## Step-by-Step Code Fix\n\nLet's illustrate this with an example.  Suppose you have a page that fetches user data using `getServerSideProps` and you want to use that data to conditionally redirect based on user role in middleware.\n\n\n**Incorrect Approach (Will Fail):**\n\n```javascript\n// pages/profile.js\nexport async function getServerSideProps(context) {\n  const res = await fetch('https://api.example.com/user');\n  const data = await res.json();\n\n  return {\n    props: {\n      user: data,\n    },\n  };\n}\n\nexport default function Profile({ user }) {\n  return <div>Welcome, {user.name}!</div>;\n}\n\n\n// middleware.js\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  const userRole = req.cookies.get('userRole'); //This is wrong and will not work\n  const isAdmin = req.cookies.get('userRole') === 'admin';  \n\n  if (!isAdmin && user.role !== 'admin') { // user is not defined here!!\n    return NextResponse.redirect(new URL('/login', req.url))\n  }\n}\n\nexport const config = {\n  matcher: '/profile',\n};\n```\n\n**Correct Approach:**\n\nThe solution is to avoid directly accessing `getServerSideProps` data within the middleware. Instead, leverage cookies, session storage (using libraries like `next-auth`), or query parameters to pass necessary information from the page component to the middleware.\n\n\n```javascript\n// pages/profile.js\nexport async function getServerSideProps(context) {\n  const res = await fetch('https://api.example.com/user');\n  const data = await res.json();\n\n  return {\n    props: {\n      user: data,\n    },\n  };\n}\n\nexport default function Profile({ user }) {\n  return <div>Welcome, {user.name}!</div>;\n}\n\n// middleware.js\nimport { NextResponse } from 'next/server'\n\nexport function middleware(req) {\n  const userRole = req.cookies.get('userRole'); //Now this is right. we set this cookie in the backend on login.\n\n\n  if (!userRole || userRole !== 'admin') {\n    return NextResponse.redirect(new URL('/login', req.url))\n  }\n}\n\nexport const config = {\n  matcher: '/profile',\n};\n```\n\nNow,  we are only checking against userRole cookie. you have to set this cookie in the backend logic after successful login.\n\n\n## Explanation\n\nMiddleware executes *before* any rendering logic, including `getServerSideProps`.  It has access to the request object but not the response data generated by the page component's data fetching functions.  Attempting to access `getServerSideProps` data directly leads to errors because that data hasn't been generated yet.  The solution is to manage the necessary data for the middleware's logic (like user authentication) separately using other methods like cookies, session storage, or query parameters.\n\n\n## External References\n\n* [Next.js Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)\n* [Next.js API Routes Documentation](https://nextjs.org/docs/api-routes/introduction)\n* [Next.js getServerSideProps Documentation](https://nextjs.org/docs/basic-features/data-fetching/getserversideprops)\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":937,"title":"Handling `getServerSideProps` Data in Next.js Middleware"}]
